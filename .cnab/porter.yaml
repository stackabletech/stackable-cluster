# This is the configuration for Porter
# You must define steps for each action, but the rest is optional
# See https://porter.sh/author-bundles for documentation on how to configure your bundle
# Uncomment out the sections below to take full advantage of what Porter can do!

name: porter-hello
version: 0.1.0
description: "An example Porter configuration"
# TODO: update the registry to your own, e.g. myregistry
registry: docker.stackable.tech/stackable

# If you want to customize the Dockerfile in use, uncomment the line below and update the referenced file. 
# See https://porter.sh/custom-dockerfile/
#dockerfile: Dockerfile.tmpl

# a more complex example:
# see: https://donmstewart.github.io/porter-kustomize/examples/

# end::[]

mixins:
  - exec:
  - kubernetes:
  - helm3:
      repositories:
        bitnami:
          url: "https://repo.stackable.tech/repository/helm-stable/"

credentials:
  - name: helm-registry-password
    env: HELM_REGISTRY_PASSWORD

parameters:
  - name: helm-registry-username
    type: string
    default: simon.nocke
  - name: hbase-name
    type: string
    default: porter-ci-hbase-cluster
  - name: namespace
    type: string
    default: 'default'
  - name: my-password
    type: string
    default: very-secure-test
    env: MY_PASSWORD
  - name: probe-timeout
    description: Timeout for liveness and readiness probes
    type: integer
    default: 1

customActions:
  status:
    description: "Get the status of a helm3 release"
    modifies: false
    stateless: true

login:
  - helm3:
      description: "Login to OCI registry"
      arguments:
        - registry
        - login
        - localhost:5000
        - "--insecure"
      flags:
        u:  "{{ bundle.parameters.helm-registry-username }}"
        p:  "{{ bundle.credentials.helm-registry-password }}"

status:
  - helm3:
      description: "Hbase Status"
      arguments:
        - status
        - "{{ bundle.parameters.hbase-name }}"
      flags:
        o: yaml

install:
  - helm3:
      description: "Install Hbase Cluster"
      name: "{{ bundle.parameters.hbase-name }}"
      chart: hbase-operator
      version: 1.6.2
      namespace: "{{ bundle.parameters.namespace }}"
  - kubernetes:
      description: "Perform Deployment for hbase java api test application"
      manifests:
        - kubernetes/manifests/
      wait: true
  - exec:
      description: "Install Hello World"
      command: ./helpers.sh
      arguments:
        - install


upgrade:
  - helm3:
      description: "Install Hbase Cluster"
      name: "{{ bundle.parameters.hbase-name }}"
      chart: hbase-operator
      version: 1.6.2
      namespace: "{{ bundle.parameters.namespace }}"

uninstall:
  - helm3:
      description: "Install Hbase Cluster"
      name: "{{ bundle.parameters.hbase-name }}"
      chart: hbase-operator
      version: 1.6.2
      namespace: "{{ bundle.parameters.namespace }}"